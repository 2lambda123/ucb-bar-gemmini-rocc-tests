# Gemmini Data Collection

## Motivation

This feature was added to Gemmini to enable large-scale, seamless data collection for various test benches applied on various configurations of Gemmini. Most of the following documentation assumes current working directory `gemmini/software/gemmini-rocc-tests/gemmini-data-collection`.

<br/>

## Script Details
>### `gemmini_data_collection.py`
* Generates three critical scripts that facilitate the data collection process, elaborated on further below

* Each call to the `main` function of this script generates an instance of a template test bench (ex. GEMM, 2D-Conv) for Gemmini simulation; it also mutates the below scripts to account for the instance

* `gemmini/data-collection-vcs.sh`
    
    * Uses the `gemmini/scripts/run-vcs.sh` script to run a faster cycle-accurate Gemmini simulation for each instance generated by the `gemmini_data_collection.py` script
    
    * Output containing cycles directed to `gemmini/data-collection-output`

* `gemmini/data-collection-midas.sh`
    
    * Uses the `gemmini/scripts/run-midas.sh` script to run a more precise cycle-accurate Gemmini simulation for each instance generated by the `gemmini_data_collection.py` script
    
    * Output containing cycles directed to `gemmini/data-collection-output`

* `gemmini/data-collection-spike.sh`
    
    * Uses the `gemmini/scripts/run-spike.sh` script to run through the "functionality" of each instance generated by the `gemmini_data_collection.py` script
    
    * When Spike is called, a switch will enable the tiling factors for the job to be outputted (does not happen when running `gemmini/data-collection-vcs.sh` or `gemmini/data-collection-midas.sh`)
    
    * Output containing tiling factors directed to `gemmini/data-collection-output`

* `clean.sh`
    
    * Cleans the output of `gemmini/software/gemmini-rocc-tests/build.sh` script
    
    * Deletes `gemmini/data-collection-output-configs` folder
    
    * Deletes `gemmini/data-collection-output` folder
    
    * Deletes `gemmini/data-collection-vcs.sh` script

    * Deletes `gemmini/data-collection-midas.sh` script
    
    * Deletes `gemmini/data-collection-spike.sh` script
    
    * Deletes all test bench instance `C` files generated from the `gemmini_data_collection.py` script
    
    * Resets `Makefile` to remove instruction to build test bench instances

>### `gen_data.sh (tile/cycle) (vcs/midas)`

* If called with the `tile` parameter, script generates output with tiling factors; if called with the `cycle` parameter, script generates output with simulation cycles

* Cleans all prior output via `clean.sh`

* Runs `gemmini_data_collection.py`

* If called with the `tile` parameter, turns switch to print tiling factors on; if called with the `cycle` parameter, turns switch to print tiling factors off (affects `gemmini/software/gemmini-rocc-tests/include/gemmini.h`) 

* Builds the `bareMetalC` tests

* If called with the `tile` parameter, calls `gemmini/data-collection-spike.sh`

* If called with the `cycle` parameter, then a second input parameter is expected (`vcs` or `midas` to specify which simulation)

    * If called with the `vcs` parameter, calls `gemmini/data-collection-vcs.sh`

    * If called with the `midas` parameter, calls `gemmini/data-collection-midas.sh`

>### `config_gen_data.sh (configName) (vcs/midas)`

* Sets the active Gemmini configuration in `gemmini/src/main/scala/gemmini/CustomConfigs.scala` to the specified `configName` Scala variable name provided as a parameter

    * If you want to use the default configuration, you should pass in `baselineInferenceConfig` as the first parameter

* Builds Spike and _either_ VCS _or_ Midas based on the chosen configuration using `gemmini/scripts/build-spike.sh` and _either_ `gemmini/scripts/build-vcs.sh` _or_ `gemmini/scripts/build-midas.sh` respectively

* Runs `gen_data.sh tile` and `gen_data.sh cycle (vcs/midas)` to collect both tiling factor data and simulation cycle data

* Places output in subfolders within the `data-collection-output-configs` folder; the subfolders follow the naming format `data-collection-output-<spike/vcs/midas>-<configName>` where the `<>` indicates variability of naming

<br/>

## User Process

> ### Step 1: Create Test Bench Template

* Make a generalized version of the test bench you want to simulate on Gemmini in the `templates` folder

* For all values of the test bench you want to make variable, replace each usage of each value with its respective `%<KEYWORD_NAME>%`

>### Step 2: Specify Instances of Test Benches

* In `gemmini_data_collection.py`, make a call to the `main` function for each instance you want to simulate for each test bench

* The call should look like the following
    * **Parameter 1**: an array of keywords used in the template
    * **Parameter 2**: an array of values to replace the keywords specified in Parameter 1 (in respective order)
    * **Parameter 3**: name of template you are using (must be a `C` file located in the `templates` folder)
    * **Parameter 4**: name of output file (`C` file) you want generated in `bareMetalC` folder 

>### Step 3: Construct Gemmini Configurations

* This step is optional and is only applicalbe if you want to collect simulation data for configurations different than the Gemmini defaults (ex. systolic array dimensions, Scratchpad size, Accumulator size)

* Go to `gemmini/src/main/scala/gemmini/CustomConfigs.scala` and create your desired Gemmini configs

* Keep note of their names â€“ you will need them for Step 4

>### Step 4: Run Script of Choice

* Refer to above descriptions of `gen_data.sh` and `config_gen_data.sh`

* Feel free to make your own script

* You must run all scripts from the `gemmini-data-collection` directory, as paths assume that this is your current working directory

